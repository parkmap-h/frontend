machine:
  services:
    - docker

dependencies:
  override:
    - docker info
    - docker build -t eiel/parkmap .
    - bin/docker_push

database:
  override:
    - docker run -d --name my-db mdillon/postgis:9.4; sleep 10
    - docker run -it --link my-db:db -e RAILS_ENV="test" eiel/parkmap rake db:create db:schema:load --trace

test:
  override:
    - docker run -it --link my-db:db -e CIRCLE_ARTIFACTS=$CIRCLE_ARTIFACTS -e CIRCLE_BRANCH=$CIRCLE_BRANCH -e CIRCLE_BUILD_NUM=$CIRCLE_BUILD_NUM -e CIRCLE_COMPARE_URL=$CIRCLE_COMPARE_URL -e CIRCLE_NODE_INDEX=$CIRCLE_NODE_INDEX -e CIRCLE_NODE_TOTAL=$CIRCLE_NODE_TOTAL -e CIRCLE_PREVIOUS_BUILD_NUM=$CIRCLE_PREVIOUS_BUILD_NUM -e CIRCLE_PROJECT_REPONAME=$CIRCLE_PROJECT_REPONAME -e CIRCLE_PROJECT_USERNAME=$CIRCLE_PROJECT_USERNAME -e CIRCLE_SHA1=$CIRCLE_SHA1 -e CIRCLE_TEST_REPORTS=$CIRCLE_TEST_REPORTS -e CIRCLE_USERNAME=$CIRCLE_USERNAME -e CIRCLECI=true -e CODECLIMATE_REPO_TOKEN=$CODECLIMATE_REPO_TOKEN  eiel/parkmap rake

deployment:
  docker:
    branch: master
    commands:
      - docker push eiel/parkmap
